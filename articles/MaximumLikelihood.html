<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="galamm">
<title>Maximum Likelihood Estimation • galamm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Maximum Likelihood Estimation">
<meta property="og:description" content="galamm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">galamm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Introduction.html">Introduction</a>
    <a class="dropdown-item" href="../articles/MaximumLikelihood.html">Maximum Likelihood Estimation</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Maximum Likelihood Estimation</h1>
            
      
      
      <div class="d-none name"><code>MaximumLikelihood.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lcbc-uio.github.io/galamm/">galamm</a></span><span class="op">)</span></span></code></pre></div>
<p>The <code>galamm</code> package includes a function for computing the Laplace approximate marginal likelihood of both GLLAMMs and GALAMMs. In the future, this will replace the profile likelihood method, but due to the complexity of the matter, it will take some time to develop a decent API. This vignette describes how to perform maximum likelihood estimation with the currently available functions; it is complicated, but also gives the benefit of understanding what’s going on, in addition to a more accurate algorithm which scales better. Before continuing, make sure you’ve read the Introduction vignette.</p>
<div class="section level2">
<h2 id="linear-mixed-model-with-factor-structure">Linear mixed model with factor structure<a class="anchor" aria-label="anchor" href="#linear-mixed-model-with-factor-structure"></a>
</h2>
<p>We will use an example dataset from the <code>PLmixed</code> package <span class="citation">(Rockwood and Jeon 2019)</span>. The <code>PLmixed</code> is probably a better choice for this model, but this way we get a gentle start before we try estimating generalized multilevel models with semiparametric terms.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">PLmixed</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"IRTsim"</span><span class="op">)</span></span>
<span><span class="va">IRTsub</span> <span class="op">&lt;-</span> <span class="va">IRTsim</span><span class="op">[</span><span class="va">IRTsim</span><span class="op">$</span><span class="va">item</span> <span class="op">&lt;</span> <span class="fl">4</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">IRTsub</span> <span class="op">&lt;-</span> <span class="va">IRTsub</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">IRTsub</span><span class="op">)</span>, <span class="fl">300</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">IRTsub</span> <span class="op">&lt;-</span> <span class="va">IRTsub</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">IRTsub</span><span class="op">$</span><span class="va">item</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">irt.lam</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="estimation-with-plmixed">Estimation with PLmixed<a class="anchor" aria-label="anchor" href="#estimation-with-plmixed"></a>
</h3>
<p>The model can be fit with <code>PLmixed</code> as follows, where we’re pretending for now the the response is normally distributed, although the binomial distribution would be correct.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">form</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">item</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">abil.sid</span> <span class="op">|</span><span class="va">sid</span><span class="op">)</span> <span class="op">+</span><span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">abil.sid</span> <span class="op">|</span><span class="va">school</span><span class="op">)</span></span>
<span><span class="va">irt.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PLmixed/man/PLmixed.html" class="external-link">PLmixed</a></span><span class="op">(</span><span class="va">form</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">IRTsub</span>, load.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"item"</span><span class="op">)</span>, <span class="co"># family = binomial,</span></span>
<span>                     REML <span class="op">=</span> <span class="cn">FALSE</span>, factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"abil.sid"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                     lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">irt.lam</span><span class="op">)</span>, iter.count <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="estimation-with-the-galamm-package">Estimation with the galamm package<a class="anchor" aria-label="anchor" href="#estimation-with-the-galamm-package"></a>
</h3>
<p>We can use the <code>marginal_likelihood</code> function from <code>galamm</code> to compute the marginal likelihood of this model at given values of fixed effects <span class="math inline">\(\beta\)</span>, variance components <span class="math inline">\(\theta\)</span>, and factor loadings <span class="math inline">\(\lambda\)</span>.</p>
<p>We start by adding <span class="math inline">\(\lambda\)</span> as a variable in the model:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">IRTsub</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">abil.sid</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre></div>
<p>We then generate the components of a linear mixed model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="va">lmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/modular.html" class="external-link">lFormula</a></span><span class="op">(</span><span class="va">form</span>, data <span class="op">=</span> <span class="va">dat</span>, REML <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The fixed effects matrix does not contain any factor loadings, so we keep it as is.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">lmod</span><span class="op">$</span><span class="va">X</span></span></code></pre></div>
<p>The random effects matrix does contain factor loadings, so we need a mapping.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Zt</span> <span class="op">&lt;-</span> <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Zt</span></span>
<span><span class="va">lambda_mapping_Zt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">item</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2L</span></span></code></pre></div>
<p>We also extract the random effects covariance matrix, with its mapping to <span class="math inline">\(\theta\)</span>. See <span class="citation">Bates et al. (2015)</span> for details.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Lambdat</span> <span class="op">&lt;-</span> <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Lambdat</span></span>
<span><span class="va">theta_mapping</span> <span class="op">&lt;-</span> <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Lind</span> <span class="op">-</span> <span class="fl">1L</span></span></code></pre></div>
<p>We can now start by confirming that we are able to compute the likelihood of the model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginal_likelihood.html">marginal_likelihood</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">y</span>,</span>
<span>  trials <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  Zt <span class="op">=</span> <span class="va">Zt</span>,</span>
<span>  Lambdat <span class="op">=</span> <span class="va">Lambdat</span>,</span>
<span>  beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html" class="external-link">fixef</a></span><span class="op">(</span><span class="va">irt.model</span><span class="op">)</span>,</span>
<span>  theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/getME.html" class="external-link">getME</a></span><span class="op">(</span><span class="va">irt.model</span><span class="op">$</span><span class="va">lme4</span>, <span class="st">"theta"</span><span class="op">)</span>,</span>
<span>  theta_mapping <span class="op">=</span> <span class="va">theta_mapping</span>,</span>
<span>  lambda <span class="op">=</span> <span class="va">irt.model</span><span class="op">$</span><span class="va">Lambda</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="st">"abil.sid"</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>  lambda_mapping_X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  lambda_mapping_Zt <span class="op">=</span> <span class="va">lambda_mapping_Zt</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"gaussian"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code>marginal_likelihood</code> function returns the deviance, which we can compare with that from <code>PLmixed</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">irt.model</span><span class="op">$</span><span class="va">`Log-Likelihood`</span></span>
<span><span class="co">#&gt; [1] 387.1267</span></span>
<span><span class="va">ml</span><span class="op">$</span><span class="va">deviance</span></span>
<span><span class="co">#&gt; [1] 387.1267</span></span></code></pre></div>
<p>The <code>marginal_likelihood</code> function also returns the gradient of the marginal likelihood with respect to <span class="math inline">\(\theta\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\lambda\)</span>, in that order. Reassuringly, it is close to zero. Not however that <code>PLmixed</code> returns the maximum of the profile likelihood, which albeit consistent, is not the same as the maximum likelihood estimate <span class="citation">(Gong and Samaniego 1981; Parke 1986; Pawitan 2001)</span>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ml</span><span class="op">$</span><span class="va">gradient</span></span>
<span><span class="co">#&gt; [1]  2.438535e-06  3.918029e-06 -5.440350e-13 -8.484958e-13 -7.526399e-13</span></span>
<span><span class="co">#&gt; [6]  4.070702e-05 -3.101126e-05</span></span></code></pre></div>
<p>This gradient is computed with algorithmic differentiation using the <code>autodiff</code> C++ library <span class="citation">(Leal 2018)</span>, which means that it is exact to computer precision.</p>
<p>We can use this gradient to find the maximum likelihood estimates of the model (technically, the Laplace approximate marginal maximum likelihood estimates). We also use <code>memoise</code> to avoid evaluating the function unnecessarily.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://memoise.r-lib.org" class="external-link">memoise</a></span><span class="op">)</span></span>
<span><span class="va">theta_inds</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span></span>
<span><span class="va">beta_inds</span> <span class="op">&lt;-</span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span></span>
<span><span class="va">lambda_inds</span> <span class="op">&lt;-</span> <span class="fl">6</span><span class="op">:</span><span class="fl">7</span></span>
<span><span class="va">bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mlwrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/marginal_likelihood.html">marginal_likelihood</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">y</span>,</span>
<span>    trials <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    X <span class="op">=</span> <span class="va">X</span>,</span>
<span>    Zt <span class="op">=</span> <span class="va">Zt</span>,</span>
<span>    Lambdat <span class="op">=</span> <span class="va">Lambdat</span>,</span>
<span>    beta <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="va">beta_inds</span><span class="op">]</span>,</span>
<span>    theta <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="va">theta_inds</span><span class="op">]</span>,</span>
<span>    theta_mapping <span class="op">=</span> <span class="va">theta_mapping</span>,</span>
<span>    lambda <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="va">lambda_inds</span><span class="op">]</span>,</span>
<span>    lambda_mapping_X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    lambda_mapping_Zt <span class="op">=</span> <span class="va">lambda_mapping_Zt</span>,</span>
<span>    family <span class="op">=</span> <span class="st">"gaussian"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mlmem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise</a></span><span class="op">(</span><span class="va">mlwrapper</span><span class="op">)</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">mlmem</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">$</span><span class="va">deviance</span></span>
<span><span class="op">}</span></span>
<span><span class="va">gr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">mlmem</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">$</span><span class="va">gradient</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We start the optimization from some pretty arbitrary values, and it converges quite fast, to a solution which is identical to the one the <code>PLmixed</code> found:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">par_init</span>, fn <span class="op">=</span> <span class="va">fn</span>, gr <span class="op">=</span> <span class="va">gr</span>, </span>
<span>             method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>, lower <span class="op">=</span> <span class="va">bounds</span><span class="op">)</span></span>
<span></span>
<span><span class="va">opt</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="co">#&gt; [1] 387.1267</span></span>
<span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">irt.model</span><span class="op">$</span><span class="va">`Log-Likelihood`</span></span>
<span><span class="co">#&gt; [1] 387.1267</span></span></code></pre></div>
<p>We can confirm that the parameters are almost identical:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="va">par</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/getME.html" class="external-link">getME</a></span><span class="op">(</span><span class="va">irt.model</span><span class="op">$</span><span class="va">lme4</span>, <span class="st">"theta"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html" class="external-link">fixef</a></span><span class="op">(</span><span class="va">irt.model</span><span class="op">)</span>, </span>
<span>    <span class="va">irt.model</span><span class="op">$</span><span class="va">Lambda</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"optim()"</span>, ylab <span class="op">=</span> <span class="st">"PLmixed"</span><span class="op">)</span>;</span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="MaximumLikelihood_files/figure-html/unnamed-chunk-14-1.png" width="384"></p>
<p>It should also be clear to the reader the <code>PLmixed</code> is MUCH more convenient to use. However, the optimization shown here is faster:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">par_init</span>, fn <span class="op">=</span> <span class="va">fn</span>, gr <span class="op">=</span> <span class="va">gr</span>, </span>
<span>             method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>, lower <span class="op">=</span> <span class="va">bounds</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.004   0.000   0.004</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">irt.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PLmixed/man/PLmixed.html" class="external-link">PLmixed</a></span><span class="op">(</span><span class="va">form</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">IRTsub</span>, load.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"item"</span><span class="op">)</span>,</span>
<span>                     REML <span class="op">=</span> <span class="cn">FALSE</span>, factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"abil.sid"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                     lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">irt.lam</span><span class="op">)</span>, iter.count <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   2.329   0.001   2.329</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="generalized-linear-mixed-models">Generalized linear mixed models<a class="anchor" aria-label="anchor" href="#generalized-linear-mixed-models"></a>
</h2>
<p>For illustrating use with generalized linear mixed models, we start by using a model without any factor structures.</p>
<p>We first fit the model using <code>lme4</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/modular.html" class="external-link">glFormula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">incidence</span>, <span class="va">size</span> <span class="op">-</span> <span class="va">incidence</span><span class="op">)</span> <span class="op">~</span> <span class="va">period</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">herd</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">cbpp</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span><span class="va">devfun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">mkGlmerDevfun</span>, <span class="va">glmod</span><span class="op">)</span></span>
<span><span class="va">opt1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/modular.html" class="external-link">optimizeGlmer</a></span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span></span>
<span><span class="va">devfun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/modular.html" class="external-link">updateGlmerDevfun</a></span><span class="op">(</span><span class="va">devfun</span>, <span class="va">glmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">)</span></span>
<span><span class="va">opt2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/modular.html" class="external-link">optimizeGlmer</a></span><span class="op">(</span><span class="va">devfun</span>, stage<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">fMod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/mkMerMod.html" class="external-link">mkMerMod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span>, <span class="va">opt2</span>, <span class="va">glmod</span><span class="op">$</span><span class="va">reTrms</span>, fr <span class="op">=</span> <span class="va">glmod</span><span class="op">$</span><span class="va">fr</span><span class="op">)</span></span></code></pre></div>
<p>Then we do it using <code>marginal_likelihood</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theta_inds</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">beta_inds</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">:</span><span class="fl">5</span></span>
<span></span>
<span><span class="va">mlwrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/marginal_likelihood.html">marginal_likelihood</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="va">cbpp</span><span class="op">$</span><span class="va">incidence</span>,</span>
<span>    trials <span class="op">=</span> <span class="va">cbpp</span><span class="op">$</span><span class="va">size</span>,</span>
<span>    X <span class="op">=</span> <span class="va">glmod</span><span class="op">$</span><span class="va">X</span>,</span>
<span>    Zt <span class="op">=</span> <span class="va">glmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Zt</span>,</span>
<span>    Lambdat <span class="op">=</span> <span class="va">glmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Lambdat</span>,</span>
<span>    beta <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="va">beta_inds</span><span class="op">]</span>,</span>
<span>    theta <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="va">theta_inds</span><span class="op">]</span>,</span>
<span>    theta_mapping <span class="op">=</span> <span class="va">glmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Lind</span> <span class="op">-</span> <span class="fl">1L</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    lambda_mapping_X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    lambda_mapping_Zt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    family <span class="op">=</span> <span class="st">"binomial"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mlmem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise</a></span><span class="op">(</span><span class="va">mlwrapper</span><span class="op">)</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">mlmem</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">$</span><span class="va">deviance</span></span>
<span><span class="op">}</span></span>
<span><span class="va">gr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">mlmem</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">$</span><span class="va">gradient</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span></span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">fn</span>, gr <span class="op">=</span> <span class="va">gr</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>, lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Using <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> with L-BFGS-B yields slightly higher deviance than <code>lme4</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="co">#&gt; [1] 184.2564</span></span>
<span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">fMod</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' 184.0531 (df=5)</span></span></code></pre></div>
<p>On the other hand, for given parameter values, they almost perfectly agree, confirming that our implementation is correct, but that some work is needed to check the optimization algorithms.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fn</span><span class="op">(</span><span class="va">opt2</span><span class="op">$</span><span class="va">par</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 184.0526</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generalized-additive-mixed-model-with-factor-structures">Generalized additive mixed model with factor structures<a class="anchor" aria-label="anchor" href="#generalized-additive-mixed-model-with-factor-structures"></a>
</h2>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: nlme</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'nlme'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:lme4':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     lmList</span></span>
<span><span class="co">#&gt; This is mgcv 1.8-40. For overview type 'help("mgcv-package")'.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gamm4</span><span class="op">)</span></span>
<span><span class="co">#&gt; This is gamm4 0.2-6</span></span></code></pre></div>
<p>We can now fit the model illustrates in the Introduction vignette, which we refer to for details.</p>
<p>We start by adding a weight column to <code>dat1</code>, to hold factor loadings.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambda_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>item1 <span class="op">=</span> <span class="fl">1</span>, item2 <span class="op">=</span> <span class="fl">2</span>, item3 <span class="op">=</span> <span class="fl">.4</span><span class="op">)</span></span>
<span><span class="va">dat1</span><span class="op">$</span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="va">lambda_init</span><span class="op">[</span><span class="va">dat1</span><span class="op">$</span><span class="va">item</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id  item         y         x weight</span></span>
<span><span class="co">#&gt; 1  1 item1  4.516161 0.5324675    1.0</span></span>
<span><span class="co">#&gt; 2  1 item2  8.955929 0.5324675    2.0</span></span>
<span><span class="co">#&gt; 3  1 item3  1.774563 0.5324675    0.4</span></span>
<span><span class="co">#&gt; 4  2 item1 10.144956 0.6560528    1.0</span></span>
<span><span class="co">#&gt; 5  2 item2 19.633269 0.6560528    2.0</span></span>
<span><span class="co">#&gt; 6  2 item3  4.525468 0.6560528    0.4</span></span></code></pre></div>
<p>To confirm that what we do is correct, we fit this GAMM at the initial values of the loadings.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gamm4/man/gamm4.html" class="external-link">gamm4</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>, by <span class="op">=</span> <span class="va">weight</span><span class="op">)</span>, random <span class="op">=</span> <span class="op">~</span><span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">weight</span><span class="op">|</span><span class="va">id</span><span class="op">)</span>, </span>
<span>              data <span class="op">=</span> <span class="va">dat1</span>, REML <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We then compute the mixed model representation of the GAMM.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/smoothCon.html" class="external-link">smoothCon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>, by <span class="op">=</span> <span class="va">weight</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat1</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/smooth2random.html" class="external-link">smooth2random</a></span><span class="op">(</span><span class="va">sm</span>, <span class="st">""</span>, type <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Then set up the list which holds the data.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="va">dat1</span><span class="op">$</span><span class="va">id</span>,</span>
<span>  y <span class="op">=</span> <span class="va">dat1</span><span class="op">$</span><span class="va">y</span>,</span>
<span>  Xf <span class="op">=</span> <span class="va">re</span><span class="op">$</span><span class="va">Xf</span>,</span>
<span>  Xr <span class="op">=</span> <span class="va">re</span><span class="op">$</span><span class="va">rand</span><span class="op">$</span><span class="va">Xr</span>,</span>
<span>  weight <span class="op">=</span> <span class="va">dat1</span><span class="op">$</span><span class="va">weight</span>,</span>
<span>  pseudoGroups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">re</span><span class="op">$</span><span class="va">rand</span><span class="op">$</span><span class="va">Xr</span><span class="op">)</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>And set up the model.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/modular.html" class="external-link">lFormula</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">Xf</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">pseudoGroups</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">weight</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span>, </span>
<span>                 data <span class="op">=</span> <span class="va">mdat</span>, REML <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Then we add the penalized part of the smooth terms.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Ztlist</span><span class="op">$</span><span class="va">`1 | pseudoGroups`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">mdat</span><span class="op">$</span><span class="va">Xr</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Zt</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Zt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Ztlist</span><span class="op">$</span><span class="va">`0 + weight | id`</span>, </span>
<span>                        <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Ztlist</span><span class="op">$</span><span class="va">`1 | pseudoGroups`</span><span class="op">)</span></span></code></pre></div>
<p>To begin with, we complete model fitting at the initial loading.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">devfun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">mkLmerDevfun</span>, <span class="va">lmod</span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/modular.html" class="external-link">optimizeLmer</a></span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span></span>
<span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/mkMerMod.html" class="external-link">mkMerMod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">devfun</span><span class="op">)</span>, <span class="va">opt</span>, <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span>, fr <span class="op">=</span> <span class="va">lmod</span><span class="op">$</span><span class="va">fr</span><span class="op">)</span></span></code></pre></div>
<p>We can now compare the fitted models. The likelihoods are equal.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">mod0</span><span class="op">$</span><span class="va">mer</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' -384.4884 (df=5)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' -384.4884 (df=5)</span></span></code></pre></div>
<p>As are the fixed effects and variance components.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html" class="external-link">fixef</a></span><span class="op">(</span><span class="va">mod0</span><span class="op">$</span><span class="va">mer</span><span class="op">)</span></span>
<span><span class="co">#&gt; Xs(x):weightFx1 Xs(x):weightFx2 </span></span>
<span><span class="co">#&gt;        6.439071       12.304543</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html" class="external-link">fixef</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span>
<span><span class="co">#&gt;       Xf1       Xf2 </span></span>
<span><span class="co">#&gt;  6.439071 12.304543</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/getME.html" class="external-link">getME</a></span><span class="op">(</span><span class="va">mod0</span><span class="op">$</span><span class="va">mer</span>, <span class="st">"theta"</span><span class="op">)</span></span>
<span><span class="co">#&gt;      id.weight Xr.s(x):weight </span></span>
<span><span class="co">#&gt;       8.094522      75.166853</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/getME.html" class="external-link">getME</a></span><span class="op">(</span><span class="va">mod1</span>, <span class="st">"theta"</span><span class="op">)</span></span>
<span><span class="co">#&gt;                id.weight pseudoGroups.(Intercept) </span></span>
<span><span class="co">#&gt;                 8.094522                75.166853</span></span></code></pre></div>
<p>We can also compare the penalized spline coefficients.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html" class="external-link">ranef</a></span><span class="op">(</span><span class="va">mod0</span><span class="op">$</span><span class="va">mer</span><span class="op">)</span><span class="op">$</span><span class="va">Xr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html" class="external-link">ranef</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span><span class="op">$</span><span class="va">pseudoGroups</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"gamm4"</span>, ylab <span class="op">=</span> <span class="st">"lme4"</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="MaximumLikelihood_files/figure-html/unnamed-chunk-31-1.png" width="384"></p>
<p>Having gained some confidence in our ability to fit a GAMM as a mixed model, we can now move on to also estimating the factor loadings. For this we use the <code>marginal_likelihood</code> function provided by this package, and we start by confirming that we get the same likelihood as with the two approaches shown above.</p>
<p>We first remove the factor loading from the design matrices.</p>
<p>The lambda mapping for <code>X</code> runs through each column.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambda_mapping_X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">$</span><span class="va">item</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2L</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">lmod</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The lambda mapping for <code>Zt</code> runs through the vector of structural nonzeros. Compressed sparse column format is used, so the <code>x</code> vector runs through columns. Each loading is repeated the following number of times:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">diffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Zt</span><span class="op">@</span><span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9</span></span>
<span><span class="co">#&gt;  [38] 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9</span></span>
<span><span class="co">#&gt;  [75] 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9</span></span>
<span><span class="co">#&gt; [112] 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9</span></span>
<span><span class="co">#&gt; [149] 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9</span></span>
<span><span class="co">#&gt; [186] 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9</span></span>
<span><span class="co">#&gt; [223] 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9</span></span>
<span><span class="co">#&gt; [260] 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9</span></span>
<span><span class="co">#&gt; [297] 9 9 9 9</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambda_mapping_Zt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">item</span>, <span class="va">times</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">item</span>, each <span class="op">=</span> <span class="va">times</span><span class="op">)</span></span>
<span><span class="op">}</span>, item <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">$</span><span class="va">item</span><span class="op">)</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">diffs</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2L</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">lmod</span><span class="op">$</span><span class="va">X</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">lambda_init</span><span class="op">[</span><span class="va">lambda_mapping_X</span> <span class="op">+</span> <span class="fl">2L</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Zt</span> <span class="op">&lt;-</span> <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Zt</span></span>
<span><span class="va">Zt</span><span class="op">@</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">Zt</span><span class="op">@</span><span class="va">x</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">lambda_init</span><span class="op">[</span><span class="va">lambda_mapping_Zt</span> <span class="op">+</span> <span class="fl">2L</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>We can confirm that they now are free of factor loadings:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Before</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lmod</span><span class="op">$</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Xf1 Xf2</span></span>
<span><span class="co">#&gt; 1 0.3497902 1.0</span></span>
<span><span class="co">#&gt; 2 0.6995805 2.0</span></span>
<span><span class="co">#&gt; 3 0.1399161 0.4</span></span>
<span><span class="co">#&gt; 4 0.7921988 1.0</span></span>
<span><span class="co">#&gt; 5 1.5843976 2.0</span></span>
<span><span class="co">#&gt; 6 0.3168795 0.4</span></span>
<span><span class="co"># After</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Xf1 Xf2</span></span>
<span><span class="co">#&gt; 1 0.3497902   1</span></span>
<span><span class="co">#&gt; 2 0.3497902   1</span></span>
<span><span class="co">#&gt; 3 0.3497902   1</span></span>
<span><span class="co">#&gt; 4 0.7921988   1</span></span>
<span><span class="co">#&gt; 5 0.7921988   1</span></span>
<span><span class="co">#&gt; 6 0.7921988   1</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>before <span class="op">=</span> <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Zt</span><span class="op">@</span><span class="va">x</span>, after <span class="op">=</span> <span class="va">Zt</span><span class="op">@</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">compmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">compmat</span>, ratio <span class="op">=</span> <span class="va">compmat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">compmat</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">compmat</span>, <span class="fl">27</span><span class="op">)</span></span>
<span><span class="co">#&gt;             before        after ratio</span></span>
<span><span class="co">#&gt;  [1,]  1.000000000  1.000000000   1.0</span></span>
<span><span class="co">#&gt;  [2,] -0.005368305 -0.005368305   1.0</span></span>
<span><span class="co">#&gt;  [3,] -0.015441528 -0.015441528   1.0</span></span>
<span><span class="co">#&gt;  [4,] -0.031062718 -0.031062718   1.0</span></span>
<span><span class="co">#&gt;  [5,] -0.022059973 -0.022059973   1.0</span></span>
<span><span class="co">#&gt;  [6,]  0.007786932  0.007786932   1.0</span></span>
<span><span class="co">#&gt;  [7,] -0.011682907 -0.011682907   1.0</span></span>
<span><span class="co">#&gt;  [8,]  0.162647515  0.162647515   1.0</span></span>
<span><span class="co">#&gt;  [9,] -0.497847112 -0.497847112   1.0</span></span>
<span><span class="co">#&gt; [10,]  2.000000000  1.000000000   2.0</span></span>
<span><span class="co">#&gt; [11,] -0.010736610 -0.005368305   2.0</span></span>
<span><span class="co">#&gt; [12,] -0.030883057 -0.015441528   2.0</span></span>
<span><span class="co">#&gt; [13,] -0.062125436 -0.031062718   2.0</span></span>
<span><span class="co">#&gt; [14,] -0.044119947 -0.022059973   2.0</span></span>
<span><span class="co">#&gt; [15,]  0.015573864  0.007786932   2.0</span></span>
<span><span class="co">#&gt; [16,] -0.023365813 -0.011682907   2.0</span></span>
<span><span class="co">#&gt; [17,]  0.325295030  0.162647515   2.0</span></span>
<span><span class="co">#&gt; [18,] -0.995694225 -0.497847112   2.0</span></span>
<span><span class="co">#&gt; [19,]  0.400000000  1.000000000   0.4</span></span>
<span><span class="co">#&gt; [20,] -0.002147322 -0.005368305   0.4</span></span>
<span><span class="co">#&gt; [21,] -0.006176611 -0.015441528   0.4</span></span>
<span><span class="co">#&gt; [22,] -0.012425087 -0.031062718   0.4</span></span>
<span><span class="co">#&gt; [23,] -0.008823989 -0.022059973   0.4</span></span>
<span><span class="co">#&gt; [24,]  0.003114773  0.007786932   0.4</span></span>
<span><span class="co">#&gt; [25,] -0.004673163 -0.011682907   0.4</span></span>
<span><span class="co">#&gt; [26,]  0.065059006  0.162647515   0.4</span></span>
<span><span class="co">#&gt; [27,] -0.199138845 -0.497847112   0.4</span></span></code></pre></div>
<p>We also remove the estimated values from <code>Lambdat</code>.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Lambdat</span> <span class="op">&lt;-</span> <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Lambdat</span></span>
<span><span class="va">Lambdat</span><span class="op">@</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Lambdat</span><span class="op">@</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then compute the marginal likelihood.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">margl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginal_likelihood.html">marginal_likelihood</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">mdat</span><span class="op">$</span><span class="va">y</span>,</span>
<span>  trials <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  Zt <span class="op">=</span> <span class="va">Zt</span>,</span>
<span>  Lambdat <span class="op">=</span> <span class="va">Lambdat</span>,</span>
<span>  beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html" class="external-link">fixef</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span>,</span>
<span>  theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/getME.html" class="external-link">getME</a></span><span class="op">(</span><span class="va">mod1</span>, <span class="st">"theta"</span><span class="op">)</span>,</span>
<span>  theta_mapping <span class="op">=</span> <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Lind</span> <span class="op">-</span> <span class="fl">1L</span>,</span>
<span>  lambda <span class="op">=</span> <span class="va">lambda_init</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  lambda_mapping_X <span class="op">=</span> <span class="va">lambda_mapping_X</span>,</span>
<span>  lambda_mapping_Zt <span class="op">=</span> <span class="va">lambda_mapping_Zt</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"gaussian"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">margl</span><span class="op">$</span><span class="va">deviance</span></span>
<span><span class="co">#&gt; [1] 768.9769</span></span>
<span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' 768.9769 (df=5)</span></span></code></pre></div>
<p>Finally, we can fit the model directly, using the same memoization technique as above.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theta_inds</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span></span>
<span><span class="va">beta_inds</span> <span class="op">&lt;-</span> <span class="fl">3</span><span class="op">:</span><span class="fl">4</span></span>
<span><span class="va">lambda_inds</span> <span class="op">&lt;-</span> <span class="fl">5</span><span class="op">:</span><span class="fl">6</span></span>
<span><span class="va">bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mlwrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/marginal_likelihood.html">marginal_likelihood</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="va">mdat</span><span class="op">$</span><span class="va">y</span>,</span>
<span>    trials <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    X <span class="op">=</span> <span class="va">X</span>,</span>
<span>    Zt <span class="op">=</span> <span class="va">Zt</span>,</span>
<span>    Lambdat <span class="op">=</span> <span class="va">Lambdat</span>,</span>
<span>    beta <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="va">beta_inds</span><span class="op">]</span>,</span>
<span>    theta <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="va">theta_inds</span><span class="op">]</span>,</span>
<span>    theta_mapping <span class="op">=</span> <span class="va">lmod</span><span class="op">$</span><span class="va">reTrms</span><span class="op">$</span><span class="va">Lind</span> <span class="op">-</span> <span class="fl">1L</span>,</span>
<span>    lambda <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="va">lambda_inds</span><span class="op">]</span>,</span>
<span>    lambda_mapping_X <span class="op">=</span> <span class="va">lambda_mapping_X</span>,</span>
<span>    lambda_mapping_Zt <span class="op">=</span> <span class="va">lambda_mapping_Zt</span>,</span>
<span>    family <span class="op">=</span> <span class="st">"gaussian"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mlmem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise</a></span><span class="op">(</span><span class="va">mlwrapper</span><span class="op">)</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">mlmem</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">$</span><span class="va">deviance</span></span>
<span><span class="op">}</span></span>
<span><span class="va">gr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">mlmem</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">$</span><span class="va">gradient</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>It ends up at the right values. Profile likelihood estimation fails from these initial values, and is much slower. Note that the deviance is lower now, because the factor loadings are estimated, rather than fixed at <span class="math inline">\((1, 2, .4)\)</span>.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">par_init</span>, fn <span class="op">=</span> <span class="va">fn</span>, gr <span class="op">=</span> <span class="va">gr</span>, </span>
<span>           method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>, lower <span class="op">=</span> <span class="va">bounds</span>, </span>
<span>           control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">opt</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="co">#&gt; [1] 768.3233</span></span>
<span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' 768.9769 (df=5)</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1]  8.0958013 74.3538736  6.3654084 11.7752912  2.0036730  0.4030848</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 768.3233</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      369      369 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</span></span></code></pre></div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-batesFittingLinearMixedEffects2015" class="csl-entry">
Bates, Douglas M, Martin Mächler, Ben Bolker, and Steve Walker. 2015. <span>“Fitting <span>Linear Mixed-Effects Models Using</span> Lme4.”</span> <em>Journal of Statistical Software</em> 67 (1): 1–48. <a href="https://doi.org/10.18637/jss.v067.i01" class="external-link">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-gongPseudoMaximumLikelihood1981" class="csl-entry">
Gong, Gail, and Francisco J. Samaniego. 1981. <span>“Pseudo <span>Maximum Likelihood Estimation</span>: <span>Theory</span> and <span>Applications</span>.”</span> <em>The Annals of Statistics</em> 9 (4): 861–69.
</div>
<div id="ref-lealAutodiffModernFast2018" class="csl-entry">
Leal, Allan M. M. 2018. <span>“Autodiff, a Modern, Fast and Expressive <span>C</span>++ Library for Automatic Differentiation.”</span>
</div>
<div id="ref-parkePseudoMaximumLikelihood1986" class="csl-entry">
Parke, William R. 1986. <span>“Pseudo <span>Maximum Likelihood Estimation</span>: <span>The Asymptotic Distribution</span>.”</span> <em>The Annals of Statistics</em> 14 (1): 355–57.
</div>
<div id="ref-pawitanAllLikelihood2001" class="csl-entry">
Pawitan, Yudi. 2001. <em>In All Likelihood</em>. <span>New York, NY</span>: <span>Oxford University Press</span>.
</div>
<div id="ref-rockwoodEstimatingComplexMeasurement2019" class="csl-entry">
Rockwood, Nicholas J., and Minjeong Jeon. 2019. <span>“Estimating <span>Complex Measurement</span> and <span>Growth Models Using</span> the <span>R Package PLmixed</span>.”</span> <em>Multivariate Behavioral Research</em> 54 (2): 288–306. <a href="https://doi.org/10.1080/00273171.2018.1516541" class="external-link">https://doi.org/10.1080/00273171.2018.1516541</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Øystein Sørensen.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
