---
title: "Linear Mixed Models with Factor Structures"
output: rmarkdown::html_vignette
bibliography: ../inst/references.bib
vignette: >
  %\VignetteIndexEntry{Linear Mixed Models with Factor Structures}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(galamm)
```

This vignette describes how `galamm` can be used to estimate linear mixed models with factor structures. Such models are an instance of the generalized linear latent and mixed models (GLLAMM) framework described by @rabe-heskethGeneralizedMultilevelStructural2004. The R package `PLmixed` [@rockwoodEstimatingComplexMeasurement2019] estimates such models using a profile likelihood algorithm initially proposed by @jeonProfileLikelihoodApproachEstimating2012. The models are also a special case of generalized additive latent and mixed models (GALAMM), and in `galamm` these models are estimated using a more direct algorithm described in @sorensenLongitudinalModelingAgeDependent2023.

## Model with a Single Factor

We use a simulated dataset from the `PLmixed` package for the example in this vignette. Note that the response should ideally be treated as binomial; we will come back in the vignette on generalized linear mixed models with factor structures.

First we set up the factor structures to be used:

```{r}
library(PLmixed)
data("IRTsim")
IRTsim$item <- factor(IRTsim$item)
irt.lam <- matrix(c(1, NA, NA, NA, NA), ncol = 1)
```

We could use the following code to fit the model with `PLmixed`.

```{r, eval=FALSE}
pl_mod <- PLmixed(
  formula = y ~ item + (0 + abil.sid | sid) + (0 + abil.sid | school),
  data = IRTsim, load.var = "item", 
  factor = list("abil.sid"), lambda = list(irt.lam), iter.count = FALSE)
summary(pl_mod)
```

Next we fit the model using `galamm`. This is typically 6-7 times faster than the corresponding call using `PLmixed`, and gives results that are identical up to some deviations due to numerics.

```{r}
galamm_mod <- galamm(
  formula = y ~ item + (0 + abil.sid | sid) + (0 + abil.sid | school),
  data = IRTsim, 
  load.var = "item", 
  factor = list("abil.sid"), 
  lambda = list(irt.lam)
  )

summary(galamm_mod)
```

## Model with Multiple Factors

We continue using the example data from `PLmixed`. We refer to  @rockwoodEstimatingComplexMeasurement2019 for a detailed description of the data and the model.

```{r}
data("KYPSsim")
KYPSsim$time <- factor(KYPSsim$time)
kyps.lam <- rbind(c( 1, 0),
                  c(NA, 0),
                  c(NA, 1),
                  c(NA, NA))
```


```{r, eval=FALSE}
kyps_plmixed <- PLmixed(
  formula = esteem ~ as.factor(time) +  (0 + hs | hid) + (0 + ms | mid) + (1 | sid), 
  data = KYPSsim,
  factor = list(c("ms", "hs")), 
  load.var = c("time"),
  lambda = list(kyps.lam)
  )

summary(kyps_plmixed)
```


```{r}
kyps_model <- galamm(
  formula = esteem ~ time + (0 + hs | hid) + (0 + ms | mid) + (1 | sid),
  data = KYPSsim, 
  factor = list(c("ms", "hs")), 
  load.var = "time",
  lambda = list(kyps.lam)
)

summary(kyps_model)
```


# References
