---
title: "Linear Mixed Models with Factor Structures"
output: rmarkdown::html_vignette
bibliography: ../inst/references.bib
vignette: >
  %\VignetteIndexEntry{Linear Mixed Models with Factor Structures}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(galamm)
```

This vignette describes how `galamm` can be used to estimate linear mixed models with factor structures. Such models are an instance of the generalized linear latent and mixed models (GLLAMM) framework described by @rabe-heskethGeneralizedMultilevelStructural2004. The R package `PLmixed` [@rockwoodEstimatingComplexMeasurement2019] estimates such models using a profile likelihood algorithm initially proposed by @jeonProfileLikelihoodApproachEstimating2012. The models are also a special case of generalized additive latent and mixed models (GALAMM), and in `galamm` these models are estimated using a more direct algorithm described in @sorensenLongitudinalModelingAgeDependent2023.

## Model with a Single Factor

We use a simulated dataset from the `PLmixed` package for the example in this vignette. Note that the response should ideally be treated as binomial; we will come back in the vignette on generalized linear mixed models with factor structures.

First we set up the factor structures to be used:

```{r}
library(PLmixed)
data("IRTsim")
IRTsim$item <- factor(IRTsim$item)
irt.lam <- c(1, NA, NA, NA, NA)
```

Then we fit the model using `PLmixed`:

```{r}
system.time({
  pl_mod <- PLmixed(
    y ~ item + (0 + abil.sid | sid) + (0 + abil.sid | school),
    data = IRTsim, load.var = "item", 
    factor = list("abil.sid"), lambda = list(irt.lam), iter.count = FALSE)
})

summary(pl_mod)
```

Next we fit the model using `galamm`:

```{r}
system.time({
  galamm_mod <- galamm(
    y ~ item + (0 + abil.sid | sid) + (0 + abil.sid | school),
    data = IRTsim, load.var = "item", 
    factor = list("abil.sid"), lambda = list(irt.lam))
})

summary(galamm_mod)
```


# References
